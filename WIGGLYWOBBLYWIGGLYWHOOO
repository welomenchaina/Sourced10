local fov = 135
local AIM_LERP = 0.6
local UPDATE_INTERVAL = 0.7

local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local Cam = workspace.CurrentCamera

local FOVring = Drawing.new("Circle")
FOVring.Visible = false
FOVring.Thickness = 2
FOVring.Color = Color3.fromRGB(128, 0, 128)
FOVring.Filled = false
FOVring.Radius = fov
FOVring.Position = Cam.ViewportSize/2

local ScreenGui = Instance.new("ScreenGui", game:GetService("CoreGui"))
local ToggleButton = Instance.new("TextButton")
ToggleButton.Size = UDim2.new(0, 120, 0, 40)
ToggleButton.Position = UDim2.new(0, 10, 0, 10)
ToggleButton.Text = "AIMBOT: OFF"
ToggleButton.BackgroundColor3 = Color3.fromRGB(30,30,30)
ToggleButton.TextColor3 = Color3.fromRGB(255,50,50)
ToggleButton.Font = Enum.Font.GothamBold
ToggleButton.TextSize = 14
ToggleButton.Parent = ScreenGui

local isAiming = false
local validNPCs = {}
local raycastParams = RaycastParams.new()
raycastParams.FilterType = Enum.RaycastFilterType.Blacklist
raycastParams.IgnoreWater = true

local function isNPC(model)
	if not model or not model:IsA("Model") then return false end
	local hum = model:FindFirstChildOfClass("Humanoid")
	if not hum or hum.Health <= 0 then return false end
	if not model:FindFirstChild("HumanoidRootPart") then return false end
	if Players:GetPlayerFromCharacter(model) then return false end
	return true
end

local function updateNPCs()
	local t = {}
	for _, obj in ipairs(workspace:GetDescendants()) do
		if isNPC(obj) then
			table.insert(t, obj)
		end
	end
	validNPCs = t
end

local function canSee(part)
	if not part then return false end
	raycastParams.FilterDescendantsInstances = { LocalPlayer.Character }
	local dir = part.Position - Cam.CFrame.Position
	local ray = workspace:Raycast(Cam.CFrame.Position, dir, raycastParams)
	return (not ray) or (ray.Instance and ray.Instance:IsDescendantOf(part.Parent))
end

local function getTarget()
	local bestPart, bestDist = nil, math.huge
	local center = Cam.ViewportSize * 0.5
	for _, npc in ipairs(validNPCs) do
		local aimPart = npc:FindFirstChild("HumanoidRootPart") or npc:FindFirstChild("Head")
		if aimPart then
			local screenPos, visible = Cam:WorldToViewportPoint(aimPart.Position)
			if visible and screenPos.Z > 0 then
				local dist = (Vector2.new(screenPos.X, screenPos.Y) - center).Magnitude
				if dist <= fov and canSee(aimPart) and dist < bestDist then
					bestDist = dist
					bestPart = aimPart
				end
			end
		end
	end
	return bestPart
end

local function aimAt(part)
	if not part then return end
	local cur = Cam.CFrame.Position
	local goal = part.Position
	if AIM_LERP >= 1 then
		Cam.CFrame = CFrame.new(cur, goal)
	else
		local newLook = (goal - cur).Unit
		local lerped = Cam.CFrame.LookVector:Lerp(newLook, AIM_LERP)
		Cam.CFrame = CFrame.new(cur, cur + lerped)
	end
end

do
	local accum = 0
	updateNPCs()
	RunService.Heartbeat:Connect(function(dt)
		FOVring.Position = Cam.ViewportSize/2
		FOVring.Radius = fov
		accum += dt
		if accum >= UPDATE_INTERVAL then
			updateNPCs()
			accum = 0
		end
		if isAiming then
			local target = getTarget()
			if target then aimAt(target) end
		end
	end)
end

ToggleButton.MouseButton1Click:Connect(function()
	isAiming = not isAiming
	FOVring.Visible = isAiming
	ToggleButton.Text = "AIMBOT: " .. (isAiming and "ON" or "OFF")
	ToggleButton.TextColor3 = isAiming and Color3.fromRGB(50,255,50) or Color3.fromRGB(255,50,50)
end)
